# WhisperPad 仕様書

## 目次

1. [概要](#1-概要)
2. [システム要件](#2-システム要件)
3. [アーキテクチャ](#3-アーキテクチャ)
4. [機能仕様](#4-機能仕様)
5. [画面仕様](#5-画面仕様)
6. [状態遷移](#6-状態遷移)
7. [データ仕様](#7-データ仕様)
8. [外部ライブラリ](#8-外部ライブラリ)

---

## 1. 概要

### 1.1 アプリケーション概要

**WhisperPad** は、macOS メニューバーに常駐する音声文字起こしアプリケーションです。グローバルホットキーで音声録音を開始し、WhisperKit によるオンデバイス音声認識でテキストに変換、クリップボードまたはファイルに出力します。

### 1.2 主要機能

| 機能                   | 説明                                                  |
| ---------------------- | ----------------------------------------------------- |
| メニューバー常駐       | システム起動時に自動起動し、メニューバーに常駐        |
| ホットキー録音         | グローバルショートカットで即座に録音開始/停止         |
| オンデバイス文字起こし | WhisperKit による完全ローカル処理（ネットワーク不要） |
| 柔軟な出力             | クリップボード、ファイル、または両方への出力          |
| メニューバーモデル切替 | メニューバーから直接 Whisper モデルを切り替え可能     |

### 1.3 ターゲットユーザー

- 音声でメモを取りたいビジネスユーザー
- 議事録を素早く作成したいユーザー
- タイピングよりも音声入力を好むユーザー
- プライバシーを重視し、クラウドサービスを避けたいユーザー

---

## 2. システム要件

### 2.1 動作環境

| 項目       | 要件                           |
| ---------- | ------------------------------ |
| OS         | macOS 14.0+ (Sonoma)           |
| プロセッサ | Apple Silicon (M1/M2/M3/M4)    |
| メモリ     | 8GB 以上推奨                   |
| ストレージ | モデルサイズに依存（下記参照） |

### 2.2 必要ストレージ

| モデル   | サイズ |
| -------- | ------ |
| tiny     | ~40MB  |
| base     | ~75MB  |
| small    | ~250MB |
| medium   | ~750MB |
| large-v3 | ~1.5GB |

### 2.3 必要な権限

| 権限             | 用途                 |
| ---------------- | -------------------- |
| マイクアクセス   | 音声録音             |
| アクセシビリティ | グローバルホットキー |

---

## 3. アーキテクチャ

### 3.1 技術スタック

| 技術                        | バージョン | 用途                 |
| --------------------------- | ---------- | -------------------- |
| Swift                       | 5.10+      | 開発言語             |
| SwiftUI                     | -          | UI フレームワーク    |
| The Composable Architecture | 1.23.1+    | 状態管理             |
| WhisperKit                  | 0.15.0+    | 音声認識             |
| HotKey                      | 0.2.1+     | グローバルホットキー |

### 3.2 ディレクトリ構造

| ディレクトリ | 説明                       |
| ------------ | -------------------------- |
| App/         | AppReducer, AppDelegate    |
| Features/    | TCA Feature モジュール     |
| Clients/     | 外部サービス連携（依存性） |
| Models/      | データモデル・設定構造体   |
| Views/       | SwiftUI ビュー             |

### 3.3 Features 構成

| Feature           | 説明                                  |
| ----------------- | ------------------------------------- |
| Recording         | 音声録音（AVFoundation）              |
| Transcription     | 文字起こし（WhisperKit）              |
| Settings          | 設定統合（5 つのサブ Feature を管理） |
| GeneralSettings   | 一般設定（起動、通知、言語）          |
| RecordingSettings | 録音設定（デバイス、出力）            |
| HotkeySettings    | ホットキー設定                        |
| IconSettings      | メニューバーアイコン設定              |
| ModelSettings     | WhisperKit モデル管理                 |

### 3.4 Clients 構成

| Client              | 説明                                 |
| ------------------- | ------------------------------------ |
| AudioRecorderClient | 録音・マイク権限管理                 |
| TranscriptionClient | WhisperKit 統合                      |
| HotKeyClient        | グローバルホットキー登録             |
| OutputClient        | クリップボード・ファイル出力・通知   |
| ModelClient         | WhisperKit モデル一元管理            |
| UserDefaultsClient  | 設定永続化・Security-Scoped Bookmark |

### 3.5 設計パターン

- **TCA (The Composable Architecture)**: 状態管理・副作用の分離
- **Dependency Injection**: Client を通じた外部サービス抽象化
- **Scope による Feature 統合**: 親 Feature が子 Feature を管理
- **Actor**: WhisperKitManager による並行処理の安全性確保

---

## 4. 機能仕様

### 4.1 メニューバー機能

#### 4.1.1 メニューバーアイコン

| 状態               | アイコン                   | 色     | 説明                           |
| ------------------ | -------------------------- | ------ | ------------------------------ |
| 未起動（アイドル） | マイクアイコン             | グレー | 待機中                         |
| 音声収録中         | マイクアイコン（波形付き） | 赤     | 録音中を示す                   |
| 文字起こし中       | 歯車アイコン（回転）       | 青     | 処理中を示す                   |
| 処理完了           | チェックマーク             | 緑     | 完了（3 秒後にアイドルに戻る） |
| エラー             | 警告アイコン               | 黄     | エラー発生                     |

#### 4.1.2 メニュー項目

| メニュー項目     | ショートカット | 説明                                                        |
| ---------------- | -------------- | ----------------------------------------------------------- |
| 録音開始/停止    | ⌘⌥R            | 状態により表示が変化（下記参照）                            |
| 最後の書き起こし | -              | 直近の書き起こし結果を表示、コピーボタン付                  |
| モデル           | -              | サブメニューでモデル選択（tiny/base/small/medium/large-v3） |
| 設定...          | ⌘,             | 設定画面を開く                                              |
| ヘルプ           | -              | ヘルプ情報を表示                                            |
| ライセンス       | -              | ライセンス情報を表示                                        |
| 終了             | ⌘Q             | アプリケーションを終了                                      |

**録音状態による表示変化**：

| 現在の状態 | 表示されるメニュー項目 |
| ---------- | ---------------------- |
| 待機中     | 録音開始               |
| 録音中     | 一時停止、録音終了     |
| 一時停止中 | 再開、録音終了         |

### 4.2 ホットキー機能

#### 4.2.1 デフォルトショートカット

| ショートカット | 動作                    | カスタマイズ |
| -------------- | ----------------------- | ------------ |
| `⌘⌥R`          | 録音開始/停止（トグル） | 可           |
| `⌘⌥P`          | 一時停止/再開           | 可           |
| `⌘⌥.`          | 録音キャンセル          | 可           |

#### 4.2.2 録音モード

| モード     | 説明         | 動作                                  |
| ---------- | ------------ | ------------------------------------- |
| **Toggle** | トグルモード | ホットキー 1 回で開始、再度押しで停止 |

#### 4.2.3 ホットキー登録仕様

| 設定項目             | 型       | 説明                     |
| -------------------- | -------- | ------------------------ |
| recordingHotKey      | KeyCombo | 録音開始/停止ホットキー  |
| recordingPauseHotKey | KeyCombo | 一時停止/再開ホットキー  |
| cancelHotKey         | KeyCombo | 録音キャンセルホットキー |

**KeyCombo**: キーコード（UInt32）と修飾キー（Command, Option, Shift, Control）の組み合わせ

### 4.3 音声録音機能

#### 4.3.1 録音設定

| 項目           | 値        | 説明           |
| -------------- | --------- | -------------- |
| サンプルレート | 16,000 Hz | Whisper 推奨値 |
| チャンネル     | モノラル  | Whisper 推奨値 |
| ビット深度     | 16bit     | 標準品質       |
| フォーマット   | WAV (PCM) | 無圧縮         |

#### 4.3.2 録音制限

| 項目             | 型     | デフォルト値 | 設定範囲     |
| ---------------- | ------ | ------------ | ------------ |
| 無音検出有効     | Bool   | true         | -            |
| 無音検出しきい値 | Double | -40dB        | -60dB〜-20dB |
| 無音自動停止時間 | Double | 3 秒         | 任意の秒数   |

#### 4.3.3 録音状態

| 状態名    | 説明                         |
| --------- | ---------------------------- |
| idle      | 待機中                       |
| preparing | 準備中                       |
| recording | 録音中（経過時間、音量付き） |
| paused    | 一時停止中                   |
| ending    | 終了処理中                   |

#### 4.3.4 一時停止・再開機能

録音中に一時停止を行い、後で再開できます。一時停止中は**マイクが完全に解放**され、macOS システムレベルでもマイク使用中と判定されません。

##### 動作方式

一時停止時にマイクを完全に解放するため、**複数セグメント方式**を採用しています：

1. **録音開始**: セグメント 0.wav を作成・録音
2. **一時停止**: stop() でマイク完全解放、セグメント 0 を保持
3. **再開**: セグメント 1.wav を新規作成・録音
4. **再度停止**: stop() でマイク完全解放、セグメント 1 を保持
5. **録音終了**: 全セグメントを AVMutableComposition で 1 ファイルに結合

##### 状態遷移

| 現在の状態           | トリガー                    | 動作                | 次の状態             |
| -------------------- | --------------------------- | ------------------- | -------------------- |
| recording（録音中）  | pauseRecordingButtonTapped  | stop() でマイク解放 | paused（一時停止中） |
| paused（一時停止中） | resumeRecordingButtonTapped | 新セグメント開始    | recording（録音中）  |

##### セグメント結合

録音終了時、複数のセグメントファイルを `AVMutableComposition` で結合します：

- **セグメント数が 1 の場合**: リネームのみ（結合不要）
- **セグメント数が 2 以上の場合**: 全セグメントを時系列順に結合

##### 結合失敗時の挙動

セグメント結合に失敗した場合：

1. 最初のセグメントのみを最終ファイルとして使用
2. ダイアログで警告を表示（「録音の一部が保存されました」）
3. 文字起こし処理は続行

**録音停止結果**：

| フィールド    | 型   | 説明                            |
| ------------- | ---- | ------------------------------- |
| url           | URL  | 最終ファイル URL                |
| isPartial     | Bool | 部分的成功か（結合失敗時 true） |
| usedSegments  | Int  | 使用されたセグメント数          |
| totalSegments | Int  | 総セグメント数                  |

##### セグメントファイル

| 項目           | 値                                            |
| -------------- | --------------------------------------------- |
| 保存先         | `~/Library/Caches/com.whisperpad.recordings/` |
| ファイル名     | `whisperpad_{identifier}_segment{N}.wav`      |
| クリーンアップ | 録音終了時に自動削除                          |

#### 4.3.5 キャンセル確認ダイアログ

録音中または一時停止中にキャンセル操作を行うと、確認ダイアログを表示します。

| 項目           | 内容                                     |
| -------------- | ---------------------------------------- |
| 表示条件       | 録音中または一時停止中のキャンセル操作時 |
| 設定で無効化   | 一般設定で確認ダイアログを OFF にできる  |
| ダイアログ内容 | 「録音をキャンセルしますか？」           |
| ボタン         | 「キャンセル」「続ける」                 |

ダイアログ無効時は、キャンセル操作で即座に録音が破棄されます。

### 4.4 文字起こし機能

#### 4.4.1 文字起こし状態

| 状態名            | 説明                 |
| ----------------- | -------------------- |
| idle              | 待機中               |
| initializingModel | モデル初期化中       |
| transcribing      | 変換中（進捗率あり） |
| completed         | 完了                 |
| failed            | 失敗                 |

### 4.5 出力機能

#### 4.5.1 出力先設定

| 出力先         | 説明                                     | デフォルト |
| -------------- | ---------------------------------------- | ---------- |
| クリップボード | システムクリップボードにコピー           | ON         |
| ファイル       | 指定フォルダにテキストファイルとして保存 | OFF        |
| 両方           | クリップボードとファイル両方に出力       | -          |

#### 4.5.2 ファイル出力設定

| 設定項目           | 型    | デフォルト値           | 説明                            |
| ------------------ | ----- | ---------------------- | ------------------------------- |
| copyToClipboard    | Bool  | true                   | クリップボードにコピー          |
| isEnabled          | Bool  | false                  | ファイル出力の有効/無効         |
| outputDirectory    | URL   | ~/Documents/WhisperPad | 出力先ディレクトリ              |
| outputBookmarkData | Data? | nil                    | Security-Scoped Bookmark データ |
| fileNameFormat     | Enum  | dateTime               | ファイル名フォーマット          |
| includeMetadata    | Bool  | true                   | メタデータを含めるか            |

**ファイル名フォーマット**：

- dateTime: `WhisperPad_yyyyMMdd_HHmmss.md`
- timestamp: `WhisperPad_timestamp.md`
- sequential: `WhisperPad_001.md`

#### 4.5.3 出力データ構造

| フィールド    | 型      | 説明                     |
| ------------- | ------- | ------------------------ |
| id            | UUID    | 一意識別子               |
| createdAt     | Date    | 作成日時                 |
| duration      | Double  | 録音時間（秒）           |
| text          | String  | 書き起こしテキスト       |
| language      | String? | 検出された言語           |
| modelUsed     | String  | 使用したモデル           |
| audioFilePath | URL?    | 元音声ファイル（保存時） |

---

## 5. 画面仕様

### 5.1 設定画面

#### 5.1.1 設定画面構成

5 つのタブで構成されます：

| タブ      | 内容                                       |
| --------- | ------------------------------------------ |
| General   | 起動設定、通知、言語、アイドルタイムアウト |
| Icon      | 各状態のアイコン・色カスタマイズ           |
| Hotkey    | 録音、一時停止、キャンセルのホットキー     |
| Recording | 入力デバイス、オーディオモニタリング、出力 |
| Model     | モデル検索・フィルタ、ダウンロード/削除    |

#### 5.1.2 一般設定

| 項目                     | 型   | デフォルト | 説明                                    |
| ------------------------ | ---- | ---------- | --------------------------------------- |
| ログイン時に起動         | Bool | false      | macOS 起動時に自動起動                  |
| 完了時に通知             | Bool | true       | 文字起こし完了時に通知センターに表示    |
| 完了音                   | Bool | true       | 処理完了時にサウンド再生                |
| 言語                     | Enum | system     | アプリケーション表示言語                |
| アイドルタイムアウト有効 | Bool | true       | WhisperKit アイドルタイムアウトの有効化 |
| アイドルタイムアウト時間 | Int  | 15         | WhisperKit アンロードまでの分数（5-60） |
| キャンセル確認ダイアログ | Bool | true       | 録音キャンセル時に確認を表示            |

#### 5.1.3 アイコン設定

各状態のメニューバーアイコンと色をカスタマイズできます。

| 状態名       | デフォルトアイコン       | デフォルト色 |
| ------------ | ------------------------ | ------------ |
| idle         | mic                      | systemGray   |
| recording    | mic.fill                 | systemRed    |
| paused       | pause.circle             | systemOrange |
| transcribing | gear                     | systemBlue   |
| completed    | checkmark.circle         | systemGreen  |
| error        | exclamationmark.triangle | systemYellow |
| cancel       | xmark.circle             | systemGray   |

- SF Symbol ピッカーで任意のアイコンを選択可能
- カラーピッカーで任意の色を選択可能

#### 5.1.4 ホットキー設定

| 機能           | デフォルト | 説明             | カスタマイズ |
| -------------- | ---------- | ---------------- | ------------ |
| 録音開始/停止  | ⌘⌥R        | Cmd + Option + R | 可           |
| 一時停止/再開  | ⌘⌥P        | Cmd + Option + P | 可           |
| 録音キャンセル | ⌘⌥.        | Cmd + Option + . | 可           |

**注意**: 他のアプリと競合する場合は変更してください。

#### 5.1.5 録音設定

**入力デバイス**

| 項目         | 入力形式       | 説明                               |
| ------------ | -------------- | ---------------------------------- |
| 入力デバイス | ドロップダウン | システムで利用可能なマイクから選択 |

**オーディオモニタリング**

| 項目       | 表示形式       | 説明                                |
| ---------- | -------------- | ----------------------------------- |
| 入力レベル | プログレスバー | リアルタイムの音量レベル（dB 表示） |

**出力設定**

| 項目                   | 入力形式         | デフォルト             | 説明                                          |
| ---------------------- | ---------------- | ---------------------- | --------------------------------------------- |
| クリップボードにコピー | チェックボックス | ON                     | 書き起こし結果をクリップボードにコピー        |
| ファイルに保存         | チェックボックス | OFF                    | 書き起こし結果をファイルに保存                |
| 保存先                 | フォルダ選択     | ~/Documents/WhisperPad | ファイル保存先ディレクトリ                    |
| ファイル名形式         | ドロップダウン   | 日時                   | 日時 / タイムスタンプ / 連番 から選択         |
| ファイル形式           | ドロップダウン   | マークダウン           | テキスト (.txt) / マークダウン (.md) から選択 |
| 元の音声ファイルも保存 | チェックボックス | OFF                    | 録音した音声ファイルも一緒に保存              |

#### 5.1.6 モデル設定

**検索・フィルタ機能**

| 項目     | 入力形式         | 説明                                     |
| -------- | ---------------- | ---------------------------------------- |
| 検索     | テキスト入力     | モデル名で絞り込み                       |
| フィルタ | セグメントボタン | 全て / ダウンロード済み / 未ダウンロード |

**モデル一覧**

| モデル   | サイズ | 状態                                     |
| -------- | ------ | ---------------------------------------- |
| tiny     | 40MB   | 未ダウンロード（ダウンロードボタン表示） |
| base     | 75MB   | ダウンロード済み                         |
| small    | 250MB  | ダウンロード済み・選択中（デフォルト）   |
| medium   | 750MB  | 未ダウンロード（ダウンロードボタン表示） |
| large-v3 | 1.5GB  | 未ダウンロード（ダウンロードボタン表示） |

**ダウンロード済みモデル管理**

| 機能       | 説明                                     |
| ---------- | ---------------------------------------- |
| モデル選択 | ダウンロード済みモデルをクリックして選択 |
| モデル削除 | 各モデルの削除ボタンでローカルから削除   |

**認識言語設定**

| 項目     | 入力形式       | デフォルト | 説明                                  |
| -------- | -------------- | ---------- | ------------------------------------- |
| 認識言語 | ドロップダウン | auto       | 日本語 / 英語 / 自動検出 など選択可能 |

---

## 6. 状態遷移

### 6.1 アプリケーション状態遷移

#### 6.1.1 起動フロー

| ステップ         | 条件       | 次のステップ               |
| ---------------- | ---------- | -------------------------- |
| App 起動         | -          | モデル確認                 |
| モデル確認       | モデルあり | Idle（待機中）へ遷移       |
| モデル確認       | モデルなし | ダウンロードプロンプト表示 |
| ダウンロード完了 | -          | Idle（待機中）へ遷移       |

#### 6.1.2 メイン状態遷移

| 現在の状態           | トリガー             | 次の状態             | 備考                      |
| -------------------- | -------------------- | -------------------- | ------------------------- |
| idle（待機中）       | ホットキー押下       | recording（録音中）  | 録音開始                  |
| recording（録音中）  | ホットキー再押下     | transcribing         | 録音終了 → 文字起こし開始 |
| recording（録音中）  | 最大録音時間到達     | transcribing         | 自動停止 → 文字起こし開始 |
| recording（録音中）  | キャンセル（Escape） | idle                 | 録音破棄                  |
| recording（録音中）  | 一時停止押下         | paused（一時停止中） | マイク解放                |
| paused（一時停止中） | 再開押下             | recording            | 新セグメント開始          |
| paused（一時停止中） | 録音終了押下         | transcribing         | 文字起こし開始            |
| paused（一時停止中） | キャンセル           | idle                 | 録音破棄                  |
| transcribing         | 処理成功             | completed（完了）    | 出力処理実行              |
| transcribing         | 処理失敗             | error（エラー）      | エラー表示                |
| completed（完了）    | 3 秒経過             | idle                 | 自動遷移                  |
| error（エラー）      | 3 秒経過             | idle                 | 自動遷移                  |

### 6.2 状態定義

| 状態名        | 説明                               |
| ------------- | ---------------------------------- |
| idle          | 待機中                             |
| recording     | 録音中                             |
| paused        | 一時停止中                         |
| transcribing  | 文字起こし中                       |
| completed     | 完了                               |
| error(String) | エラー（関連エラーメッセージ付き） |

### 6.3 メニューバーアイコン状態

| AppStatus       | アイコン                   | 色           | アニメーション           |
| --------------- | -------------------------- | ------------ | ------------------------ |
| `.idle`         | `mic`                      | systemGray   | なし                     |
| `.recording`    | `mic.fill`                 | systemRed    | パルス（波形）           |
| `.paused`       | `pause.circle`             | systemOrange | なし                     |
| `.transcribing` | `gear`                     | systemBlue   | 回転                     |
| `.completed`    | `checkmark.circle`         | systemGreen  | なし（3 秒後に idle へ） |
| `.error`        | `exclamationmark.triangle` | systemYellow | なし                     |
| `.cancel`       | `xmark.circle`             | systemGray   | なし                     |

---

## 7. データ仕様

### 7.1 永続化データ

#### 7.1.1 UserDefaults キー

| キー                         | 型          | 説明                     |
| ---------------------------- | ----------- | ------------------------ |
| `WhisperPad.settings`        | Data (JSON) | アプリケーション設定     |
| `WhisperPad.storageBookmark` | Data        | モデル保存先ブックマーク |
| `WhisperPad.defaultModel`    | String      | デフォルトモデル名       |

#### 7.1.2 設定モデル構成

| モデル                | 説明                           |
| --------------------- | ------------------------------ |
| AppSettings           | アプリケーション統合設定       |
| GeneralSettings       | 一般設定（起動、通知、言語）   |
| HotKeySettings        | ホットキー設定                 |
| RecordingSettings     | 録音設定（デバイス、無音検出） |
| TranscriptionSettings | 文字起こし設定（モデル、言語） |
| FileOutputSettings    | ファイル出力設定               |
| MenuBarIconSettings   | メニューバーアイコン設定       |

### 7.2 一時データ

| データ           | 保存先                         | 寿命           |
| ---------------- | ------------------------------ | -------------- |
| 録音中音声       | `NSTemporaryDirectory()`       | 処理完了まで   |
| モデルキャッシュ | `~/Library/Caches/WhisperPad/` | 明示的削除まで |

---

## 8. 外部ライブラリ

| ライブラリ                                                          | バージョン | 用途                 | ライセンス |
| ------------------------------------------------------------------- | ---------- | -------------------- | ---------- |
| [WhisperKit](https://github.com/argmaxinc/WhisperKit)               | 0.15.0+    | 音声認識             | MIT        |
| [TCA](https://github.com/pointfreeco/swift-composable-architecture) | 1.23.1+    | 状態管理             | MIT        |
| [HotKey](https://github.com/soffes/HotKey)                          | 0.2.1+     | グローバルホットキー | MIT        |
